<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Order Slip</title>

<style>
body{
    font-family: Arial;
    margin:0;
    padding:0;
    text-align:center;
}

#chartSelector{
    margin:10px;
    padding:5px;
}

#viewer{
    position:relative;
    display:inline-block;
    border:2px solid #000;
    margin-top:10px;
    max-width:95%;
    cursor:pointer;
}

#chartImage{
    width:100%;
    height:auto;
    display:block;
}

.box{
    position:absolute;
    border:2px solid red;
    color:red;
    font-weight:bold;
    font-size:14px;
    display:flex;
    justify-content:center;
    align-items:center;
    pointer-events:none;
}

#controls{
    margin-top:10px;
}

button{
    padding:8px 15px;
    margin:5px;
    font-size:16px;
    cursor:pointer;
}

#itemSelect{
    padding:5px;
    font-size:16px;
}

.fullscreen{
    position:fixed !important;
    top:0;
    left:0;
    width:100vw !important;
    height:100vh !important;
    background:#fff;
    z-index:9999;
}

.fullscreen img{
    width:100vw !important;
}
</style>
</head>

<body>

<h2>Order Slip</h2>

<select id="chartSelector"></select>

<br>

<div id="viewer">
    <img id="chartImage">
</div>

<div id="controls">
    <button onclick="prevItem()">⬅</button>
    <select id="itemSelect"></select>
    <button onclick="nextItem()">➡</button>
    <br>
    <button onclick="selectYes()">YES</button>
    <button onclick="selectNo()">NO</button>
</div>

<script>
let chartsData = {};
let currentChart = null;
let itemsKeys = [];
let currentIndex = 0;

const chartSelector = document.getElementById("chartSelector");
const chartImage = document.getElementById("chartImage");
const viewer = document.getElementById("viewer");
const itemSelect = document.getElementById("itemSelect");


// LOAD CHARTS
fetch("charts/charts.json")
.then(res=>res.json())
.then(data=>{
    chartsData = data;
    initCharts();
})
.catch(err=>{
    console.error("Chart load error:", err);
});


function initCharts(){
    chartSelector.innerHTML = "";

    Object.keys(chartsData).forEach(key=>{
        const opt = document.createElement("option");
        opt.value = key;
        opt.textContent = chartsData[key].name;
        chartSelector.appendChild(opt);
    });

    chartSelector.onchange = loadSelectedChart;

    loadSelectedChart();
}


function loadSelectedChart(){
    currentChart = chartsData[chartSelector.value];
    if(!currentChart) return;

    itemsKeys = Object.keys(currentChart.items);
    currentIndex = 0;

    chartImage.onload = () => {
        renderDropdown();
        renderBoxes();
    };

    chartImage.src = currentChart.pages[0].image;
}


function renderDropdown(){
    itemSelect.innerHTML = "";

    itemsKeys.forEach((key,index)=>{
        const opt = document.createElement("option");
        opt.value = index;
        opt.textContent = key;
        itemSelect.appendChild(opt);
    });

    itemSelect.value = currentIndex;

    itemSelect.onchange = ()=>{
        currentIndex = parseInt(itemSelect.value);
        renderBoxes();
    };
}


function renderBoxes(){
    if(!chartImage.naturalWidth) return;

    document.querySelectorAll(".box").forEach(b=>b.remove());

    const imgWidth = chartImage.clientWidth;
    const imgHeight = chartImage.clientHeight;

    const scaleX = imgWidth / chartImage.naturalWidth;
    const scaleY = imgHeight / chartImage.naturalHeight;

    Object.keys(currentChart.items).forEach(k=>{
        const it = currentChart.items[k];

        const div = document.createElement("div");
        div.className = "box";
        div.style.left = (it.x * scaleX) + "px";
        div.style.top = (it.y * scaleY) + "px";
        div.style.width = (it.w * scaleX) + "px";
        div.style.height = (it.h * scaleY) + "px";
        div.textContent = k;

        viewer.appendChild(div);
    });

    itemSelect.value = currentIndex;
}


function nextItem(){
    if(currentIndex < itemsKeys.length - 1){
        currentIndex++;
        renderBoxes();
    }
}

function prevItem(){
    if(currentIndex > 0){
        currentIndex--;
        renderBoxes();
    }
}

function selectYes(){
    alert("YES: " + itemsKeys[currentIndex]);
    nextItem();
}

function selectNo(){
    alert("NO: " + itemsKeys[currentIndex]);
    nextItem();
}


// KEYBOARD SUPPORT
document.addEventListener("keydown",e=>{
    if(e.key==="ArrowRight") nextItem();
    if(e.key==="ArrowLeft") prevItem();
    if(e.key==="Enter") selectYes();
    if(e.key==="Backspace") selectNo();
});


// FULL SCREEN TOGGLE
viewer.addEventListener("click",()=>{
    viewer.classList.toggle("fullscreen");
    setTimeout(renderBoxes,100);
});


// Re-render on window resize
window.addEventListener("resize", renderBoxes);

</script>

</body>
</html>