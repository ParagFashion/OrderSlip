<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>OrderSlip — Ordering (Index navigation)</title>
<style>
  :root{font-family: "Segoe UI", Roboto, Arial, sans-serif; color:#222;}
  body{max-width:920px;margin:18px auto;padding:18px;background:#fffdf7;}
  h1{color:#ff6f00;margin:0 0 10px;font-size:20px}
  .top-row{display:flex;gap:12px;align-items:center;margin-bottom:12px}
  select, input[type="number"]{padding:8px;border-radius:8px;border:2px solid #ffd180;background:#fffaf3}
  button{padding:10px 14px;border-radius:10px;border:none;color:#fff;background:linear-gradient(135deg,#03a9f4,#0288d1);cursor:pointer}
  button:disabled{opacity:.45;cursor:default}
  .nav-btn{background:linear-gradient(135deg,#757575,#424242);min-width:48px}
  .yes{background:linear-gradient(135deg,#4caf50,#2e7d32)}
  .no{background:linear-gradient(135deg,#f44336,#c62828)}
  .undo{background:linear-gradient(135deg,#ff9800,#ff5722)}
  .main {
    display:flex;
    gap:18px;
    align-items:flex-start;
  }
  .center {
    flex:1;
    text-align:center;
  }
  .current-code{
    font-size:46px;
    color:#0097a7;
    margin:10px 0;
    letter-spacing:1px;
  }
  .meta{font-size:14px;color:#555;margin-bottom:8px}
  .controls{display:flex;gap:8px;justify-content:center;margin-top:8px}
  .qty{display:inline-block;margin-left:8px}
  .orders{
    width:340px;
    background:#fff7ed;
    padding:12px;border-radius:12px;box-shadow:0 8px 20px rgba(0,0,0,.08)
  }
  .orders h3{margin:0 0 8px;font-size:16px;color:#ff6f00}
  .order-row{display:flex;justify-content:space-between;align-items:center;padding:6px 4px;border-bottom:1px dashed #ddd}
  .order-row:last-child{border-bottom:none}
  .order-row small{color:#666}
  .counts{margin-top:8px;font-size:14px}
  .hint{margin-top:8px;color:#666;font-size:13px}
  .file-load{margin-left:8px}
  .footer{margin-top:10px}
</style>
</head>
<body>

<h1>OrderSlip — Ordering</h1>

<!-- top controls -->
<div class="top-row">
  <label for="chartFile">Load chart JSON:</label>
  <input type="file" id="chartFile" accept=".json" class="file-load">
  <div style="margin-left:12px;color:#333">Or use sample chart (preloaded)</div>
</div>

<div class="top-row">
  <div>
    Chart: <strong id="chartName">Sample Chart</strong><br>
    <span class="meta">Shop: JJ &nbsp; | &nbsp; Date: <span id="orderDate"></span></span>
  </div>
</div>

<div class="main">
  <!-- center: navigation / current item -->
  <div class="center">

    <div style="display:flex;gap:10px;align-items:center;justify-content:center;margin-bottom:8px">
      <button id="prevBtn" class="nav-btn">◀</button>

      <select id="codeSelect" style="min-width:260px;padding:10px;border-radius:10px;">
        <!-- filled by JS -->
      </select>

      <button id="nextBtn" class="nav-btn">▶</button>
    </div>

    <div class="meta" id="currentMeta"></div>

    <div class="current-code" id="currentCode">—</div>

    <div class="meta" id="currentColor">Color: -</div>

    <div class="controls">
      <button id="yesBtn" class="yes">YES</button>
      <button id="noBtn" class="no">NO</button>

      Qty:
      <input id="qtyInput" type="number" value="30" min="1" style="width:88px;margin-left:6px">
    </div>

    <div class="hint">
      Navigation: ← / → arrows, Enter = YES, Backspace = NO. Use dropdown to jump.
    </div>

  </div>

  <!-- right: orders list -->
  <div class="orders">
    <h3>Orders</h3>

    <div id="ordersList">
      <div style="color:#666">No orders yet</div>
    </div>

    <div class="counts">
      Items: <b id="totalItems">0</b><br>
      Qty: <b id="totalQty">0</b>
    </div>

    <div style="margin-top:8px;">
      <button id="undoBtn" class="undo">Undo Last</button>
      <button id="clearBtn" style="background:linear-gradient(135deg,#9e9e9e,#616161);margin-left:6px">Clear</button>
    </div>

    <div class="footer">
      <button id="exportBtn" style="background:linear-gradient(135deg,#03a9f4,#0288d1);width:100%">Export Orders JSON</button>
    </div>
  </div>
</div>

<script>
/* ========= Sample chart (object keyed by full code) =========
   The ordering page will use only the keys (codes) to navigate.
   Each item may contain metadata like page, color etc. */
let chart = {
  name: "Sample Chart",
  pages: [
    { id: 1, image: "images/page1.png" },
    { id: 2, image: "images/page2.jpg" }
  ],
  items: {
    "G401": { page:1, x:100, y:180, w:160, h:200, color: "Red" },
    "G402": { page:1, x:280, y:180, w:150, h:200, color: "Blue" },
    "B420": { page:2, x:80, y:120, w:170, h:190, color: "Black" },
    "B421": { page:2, x:260, y:120, w:150, h:190, color: "Green" }
  }
};

/* ========= State ========= */
let itemList = [];          // ordered array of codes
let currentIndex = 0;
let orders = [];            // { code, qty, timestamp }

/* ========= DOM ========= */
const chartNameEl = document.getElementById('chartName');
const orderDateEl = document.getElementById('orderDate');
const codeSelect = document.getElementById('codeSelect');
const currentCodeEl = document.getElementById('currentCode');
const currentMetaEl = document.getElementById('currentMeta');
const currentColorEl = document.getElementById('currentColor');

const prevBtn = document.getElementById('prevBtn');
const nextBtn = document.getElementById('nextBtn');
const yesBtn = document.getElementById('yesBtn');
const noBtn = document.getElementById('noBtn');
const qtyInput = document.getElementById('qtyInput');

const ordersListEl = document.getElementById('ordersList');
const totalItemsEl = document.getElementById('totalItems');
const totalQtyEl = document.getElementById('totalQty');
const undoBtn = document.getElementById('undoBtn');
const clearBtn = document.getElementById('clearBtn');
const exportBtn = document.getElementById('exportBtn');

const chartFileInput = document.getElementById('chartFile');

/* ========= Utils ========= */

// parse code into {prefix, num} for sorting
function parseCode(code){
  const m = String(code).match(/^([^\d]*)(\d+)$/);
  if(m) return {prefix: m[1] || '', num: parseInt(m[2],10)};
  return {prefix: code, num: 0};
}
function codeCompare(a,b){
  const A = parseCode(a), B = parseCode(b);
  if(A.prefix < B.prefix) return -1;
  if(A.prefix > B.prefix) return 1;
  return A.num - B.num;
}

/* ========= Initialization ========= */

function initFromChart(c){
  chart = c;
  chartNameEl.textContent = chart.name || 'Chart';
  orderDateEl.textContent = new Date().toLocaleDateString('en-GB').replaceAll('/','-');

  // build ordered list of codes
  itemList = Object.keys(chart.items || {}).sort(codeCompare);
  currentIndex = 0;
  buildDropdown();
  renderCurrent();
  renderOrders();
}

function buildDropdown(){
  codeSelect.innerHTML = '';
  itemList.forEach((code, idx)=>{
    const opt = document.createElement('option');
    opt.value = idx;
    opt.textContent = code;
    codeSelect.appendChild(opt);
  });
  codeSelect.selectedIndex = currentIndex;
}

/* ========= Navigation & Rendering ========= */

function renderCurrent(){
  if(itemList.length === 0){
    currentCodeEl.textContent = '—';
    currentMetaEl.textContent = '';
    currentColorEl.textContent = 'Color: -';
    prevBtn.disabled = true;
    nextBtn.disabled = true;
    yesBtn.disabled = true;
    noBtn.disabled = true;
    codeSelect.disabled = true;
    return;
  }

  codeSelect.disabled = false;
  yesBtn.disabled = false;
  noBtn.disabled = false;

  // clamp
  if(currentIndex < 0) currentIndex = 0;
  if(currentIndex > itemList.length - 1) currentIndex = itemList.length - 1;

  const code = itemList[currentIndex];
  const meta = chart.items[code] || {};

  currentCodeEl.textContent = code;
  currentMetaEl.textContent = `Page: ${meta.page ?? '-'}`;
  currentColorEl.textContent = `Color: ${meta.color ?? '-'}`;

  // update dropdown
  codeSelect.selectedIndex = currentIndex;

  // enable/disable nav buttons at ends
  prevBtn.disabled = (currentIndex === 0);
  nextBtn.disabled = (currentIndex === itemList.length - 1);
}

/* ========= Actions ========= */

function goPrev(){
  if(currentIndex > 0){
    currentIndex--;
    renderCurrent();
  }
}
function goNext(){
  if(currentIndex < itemList.length - 1){
    currentIndex++;
    renderCurrent();
  }
}

function doYes(){
  if(itemList.length === 0) return;
  const code = itemList[currentIndex];
  const qty = Math.max(1, Math.round(Number(qtyInput.value) || 0));
  orders.push({ code, qty, ts: Date.now() });
  renderOrders();
  // advance automatically if not at last
  if(currentIndex < itemList.length - 1){
    currentIndex++;
    renderCurrent();
  }
}
function doNo(){
  // NO just moves forward (if not last)
  if(currentIndex < itemList.length - 1){
    currentIndex++;
    renderCurrent();
  }
}

function renderOrders(){
  ordersListEl.innerHTML = '';
  if(orders.length === 0){
    ordersListEl.innerHTML = '<div style="color:#666">No orders yet</div>';
  } else {
    orders.forEach((o, idx)=>{
      const row = document.createElement('div');
      row.className = 'order-row';
      row.innerHTML = `<div><strong>${o.code}</strong><br><small>${new Date(o.ts).toLocaleTimeString()}</small></div>
                       <div><small>qty</small> <b>${o.qty}</b></div>`;
      // allow removing individual order
      row.addEventListener('dblclick', ()=> {
        // double click to remove
        orders.splice(idx,1);
        renderOrders();
      });
      ordersListEl.appendChild(row);
    });
  }
  totalItemsEl.textContent = orders.length;
  totalQtyEl.textContent = orders.reduce((s,i)=>s+i.qty,0);
}

/* ========= Undo / Clear / Export ========= */

undoBtn.addEventListener('click', ()=> {
  if(orders.length) {
    orders.pop();
    renderOrders();
  }
});

clearBtn.addEventListener('click', ()=> {
  if(confirm('Clear all orders?')) {
    orders = [];
    renderOrders();
  }
});

exportBtn.addEventListener('click', ()=> {
  const payload = { orders, chartName: chart.name, generatedAt: new Date().toISOString() };
  const blob = new Blob([JSON.stringify(payload,null,2)], {type:"application/json"});
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = 'orders.json';
  a.click();
});

/* ========= Dropdown change (skip) ========= */
codeSelect.addEventListener('change', (e) => {
  const idx = Number(codeSelect.value);
  if(Number.isFinite(idx) && idx >= 0 && idx < itemList.length){
    currentIndex = idx;
    renderCurrent();
  }
});

/* ========= Buttons ========= */
prevBtn.addEventListener('click', goPrev);
nextBtn.addEventListener('click', goNext);
yesBtn.addEventListener('click', doYes);
noBtn.addEventListener('click', doNo);

/* ========= Keyboard support ========= */
document.addEventListener('keydown', (e) => {
  // ignore if user focused on an input element (except qty)
  const active = document.activeElement;
  if(active && (active.tagName === 'INPUT' || active.tagName === 'SELECT' || active.tagName === 'TEXTAREA')) {
    // allow Enter when qty input focused to act as YES
    if(active === qtyInput && e.key === 'Enter') {
      e.preventDefault();
      doYes();
    }
    // otherwise ignore keyboard nav
    if(active !== qtyInput) return;
  }

  if(e.key === 'ArrowLeft') { e.preventDefault(); goPrev(); }
  else if(e.key === 'ArrowRight') { e.preventDefault(); goNext(); }
  else if(e.key === 'Enter') { e.preventDefault(); doYes(); }
  else if(e.key === 'Backspace') { e.preventDefault(); doNo(); }
});

/* ========= Load chart file support ========= */
chartFileInput.addEventListener('change', (ev)=>{
  const f = ev.target.files[0];
  if(!f) return;
  const r = new FileReader();
  r.onload = () => {
    try {
      const parsed = JSON.parse(r.result);
      // Expecting user chart has { name, pages, items } structure
      if(parsed && parsed.items) {
        initFromChart(parsed);
      } else {
        alert('Invalid chart JSON (no items).');
      }
    } catch(err) {
      alert('Invalid JSON file.');
    }
  };
  r.readAsText(f);
});

/* ========= Start with sample chart ========= */
initFromChart(chart);

</script>
</body>
</html>